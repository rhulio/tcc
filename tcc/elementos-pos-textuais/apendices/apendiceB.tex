\apendice{CÃ³digo: Qualidade de Sinal - Wi-Fi}
\label{ap:apendice-wifi}

\begin{lstlisting}[
    basicstyle=\tiny,
]
#include <WiFi.h>

const char* ssid = "# Cipriano";
const char* senha = "senha da minha casa";

#include <MQTT.h>

WiFiClient net;
MQTTClient mqtt;

const char* token = "438C1C";

String float2str(float x, byte precision = 2) {
  char tmp[50];
  dtostrf(x, 0, precision, tmp);
  return String(tmp);
}

bool conectaWiFi() {
  if (WiFi.status() != WL_CONNECTED) {
    delay(250);
    return 0;
  } else
    return 1;
}

void wdt() {
  yield();
}

void setup() {
  Serial.begin(9600);

  WiFi.disconnect(true);
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, senha);
  WiFi.setSleep(false);
  
  conectaWiFi();
    
  mqtt.begin("mqtt.rscada.ga", net);
  mqtt.connect(token, token, token);
  mqtt.subscribe(String(token)+"/monitoramento");
}

bool monitoramento = true;

void callback(char* topico, byte* msg, unsigned int tamanho) {
    String mensagem;
  
	for (int i = 0; i < tamanho; i++)
		mensagem += (char)msg[i];

	if (String(topico) == String(token)+"/monitoramento")
		if(mensagem == "on")
			monitoramento = true;
		else
			monitoramento = false;
  	}
}

unsigned long tempoTotal = 0;
  
void loop() {
  if(conectaWiFi() && monitoramento == true){
    String sinal = String(WiFi.RSSI());

    unsigned long tempoInicial = millis();    

    if(mqtt.connected()){
      mqtt.publish(String(token)+"/sinal", sinal, false, 1);
      tempoTotal = millis() - tempoInicial;

      if(tempoTotal > 0)
        mqtt.publish(String(token)+"/latencia", String(tempoTotal), false, 1);
    } else {
      mqtt.disconnect();
      mqtt.connect(token, token, token);
    }

    while((millis() - tempoInicial) < 200) wdt();
  }
  wdt();
}
\end{lstlisting}